<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Receipt Digitizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
   <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'DM Sans', system-ui, sans-serif;
        background: linear-gradient(180deg, #f5d5d8 0%, #e8b4b8 50%, #d4989c 100%);
        min-height: 100vh;
        color: #1f2937;
        padding: 0px;
    }

    /* Navbar */
    .navbar {
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 40px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(219, 39, 119, 0.15);
        transition: transform 0.7s ease-in-out;
    }

    .nav-left, .nav-right {
        display: flex;
        gap: 24px;
    }

    .nav-item {
        text-decoration: none;
        color: #2d2d2d;
        font-weight: 500;
        padding: 8px 20px;
        border-radius: 8px;
        transition: 0.3s;
        font-size: 14px;
        font-family: 'Space Grotesk', sans-serif;
        cursor: pointer;
        background: none;
        border: none;
    }

    .nav-item:hover {
        background: rgba(219, 39, 119, 0.08);
        color: #db2777;
    }

    .nav-item.active {
        background: #db2777;
        color: white;
        font-weight: 600;
    }

    /* Container */
    .container {
        max-width: 1100px;
        margin: auto;
        padding: 20px;
    }

    /* Header (Big centered title) */
    .header {
        text-align: center;
        margin-bottom: 40px;
        padding-top: 40px;
    }

    .header h1 {
        font-size: 80px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
        color: #2d2d2d;
        margin-bottom: 10px;
        letter-spacing: -2px;
    }

    .header p {
        color: #4a4a4a;
        font-weight: 500;
        font-size: 18px;
    }

    /* Card (main content wrapper) */
    .card {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        margin-top: 60px; 
        padding: 40px;
        box-shadow: 0 20px 60px rgba(219, 39, 119, 0.15);
        border: 1px solid rgba(219, 39, 119, 0.1);
    }

    /* Upload Section */
    .upload {
        border: 2.5px dashed #db2777;
        padding: 60px 30px;
        text-align: center;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #fff5f8 0%, #ffe8f0 100%);
    }

    .upload:hover {
        background: linear-gradient(135deg, #ffe8f0 0%, #ffd9e8 100%);
        transform: translateY(-2px);
        border-color: #be185d;
    }

    .upload.drag-over {
        background: #ffd9e8;
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(219, 39, 119, 0.25);
    }

    .upload h2 {
        margin-bottom: 8px;
        color: #db2777;
        font-size: 28px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
    }

    .upload p {
        color: #4a4a4a;
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 15px;
    }

    input[type=file] {
        display: none;
    }

    .btn {
        background: #db2777;
        color: white;
        border: none;
        padding: 14px 34px;
        border-radius: 10px;
        cursor: pointer;
        margin-top: 20px;
        font-weight: 600;
        font-family: inherit;
        transition: all 0.3s ease;
        font-size: 15px;
    }

    .btn:hover {
        background: #be185d;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(219, 39, 119, 0.35);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Results Section */
    .results {
        margin-top: 40px;
    }

    .section {
        background-color: #fff;
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 16px;
        border: 1px solid rgba(219, 39, 119, 0.1);
    }

    .section h3 {
        color: #db2777;
        margin-bottom: 20px;
        font-size: 24px;
        font-weight: 700;
        font-family: 'Space Grotesk', sans-serif;
    }

    /* Filters */
    .filters {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .filters input {
        padding: 14px 18px;
        border: 2px solid #f3b8cd;
        border-radius: 10px;
        flex: 1;
        background: white;
        color: #2d2d2d;
        font-size: 14px;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .filters input:focus {
        outline: none;
        border-color: #db2777;
        background: #fff5f8;
        box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.1);
    }

    .filters input::placeholder {
        color: #9ca3af;
    }

    /* Table */
    table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 14px;
        overflow: hidden;
    }

    thead {
        background: #db2777;
        color: white;
    }

    th {
        padding: 18px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    td {
        padding: 18px 16px;
        text-align: left;
        border-bottom: 1px solid #f3e8ff;
        color: #2d2d2d;
        font-weight: 500;
        font-size: 15px;
    }

    tbody tr {
        background: white;
        transition: all 0.3s ease;
    }

    tbody tr:hover {
        background: #fff5f8;
        transform: scale(1.002);
    }

    button.view-btn, button.delete-btn {
        padding: 10px 18px;
        margin-right: 8px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        font-family: inherit;
        transition: all 0.3s ease;
    }

    .view-btn {
        background: #db2777;
        color: white;
        box-shadow: 0 3px 10px rgba(219, 39, 119, 0.25);
    }

    .view-btn:hover {
        background: #be185d;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(219, 39, 119, 0.35);
    }

    .delete-btn {
        background: #ef4444;
        color: white;
        box-shadow: 0 3px 10px rgba(239, 68, 68, 0.25);
    }

    .delete-btn:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.35);
    }

    /* No receipts message */
    #noReceipts {
        text-align: center;
        color: #6b7280;
        padding: 40px;
        font-size: 16px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header h1 {
            font-size: 48px;
        }

        .navbar {
            flex-direction: column;
            gap: 12px;
        }

        .filters {
            flex-direction: column;
        }

        .card {
            padding: 25px;
        }

        table {
            font-size: 12px;
        }

        th, td {
            padding: 12px 10px;
        }
    }
</style>
</head>
<body>

    <!-- Navbar -->
    <header class="navbar">
        <div class="nav-left">
            <a href="#dashboard" class="nav-item active">Dashboard</a>
            <a href="#analytics" class="nav-item">Analytics</a>
        </div>

        <div class="nav-right">
            <span class="nav-item" id="username">Welcome, User</span>
            <button class="nav-item" id="logoutBtn">Logout</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">

        <!-- Big Centered Header -->
        <div class="header">
            <h1>Receipt & Invoice Digitizer</h1>
            <p>AI-powered receipt analysis and storage</p>
        </div>

        <!-- Main Card -->
        <div class="card">

            <!-- Upload Section -->
            <div class="upload" id="uploadArea">
                <h2>Upload Receipt/Invoice</h2>
                <p>Drag & drop or click to select</p>
                <button class="btn" onclick="fileInput.click()">Select File</button>
                <input type="file" id="fileInput" accept="image/*,.pdf">
            </div>

            <!-- Results Section -->
            <div class="results">
                <div class="section">
                    <h3>Your Receipts</h3>

                    <!-- Search/Filter -->
                    <div class="filters">
                        <input type="text" id="searchInput" placeholder="ðŸ” Search by vendor...">
                        <input type="date" id="dateFilter">
                    </div>

                    <!-- Receipts Table -->
                    <table id="receiptsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vendor</th>
                                <th>Invoice #</th>
                                <th>Amount</th>
                                <th>Tax</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="receiptsBody">
                            <!-- Receipts will be inserted here by JavaScript -->
                        </tbody>
                    </table>

                    <p id="noReceipts" style="display:none;">No receipts uploaded yet. Start by uploading your first receipt!</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Auto-hide navbar on scroll
        let lastScrollY = window.scrollY;
        const navbar = document.querySelector(".navbar");

        window.addEventListener("scroll", () => {
            if (window.scrollY > lastScrollY && window.scrollY > 60) {
                navbar.style.transform = "translateY(-100%)";
            } else {
                navbar.style.transform = "translateY(0)";
            }
            lastScrollY = window.scrollY;
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Error:', error);
                window.location.href = '/';
            }
        });

        // --- FILE UPLOAD LOGIC ---
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");

        let selectedFile = null;

        // File selected
        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                uploadFile(selectedFile);
            }
        });

        // Drag & Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            selectedFile = e.dataTransfer.files[0];
            if (selectedFile) {
                uploadFile(selectedFile);
            }
        });

        // Upload file function
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('Receipt uploaded successfully!');
                    fileInput.value = '';
                    loadReceipts();
                } else {
                    alert('Upload failed: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Upload failed. Please try again.');
            }
        }

        // --- LOAD RECEIPTS FROM BACKEND ---
        async function loadReceipts() {
            try {
                const response = await fetch('/api/receipts');
                const data = await response.json();

                if (data.success) {
                    displayReceipts(data.receipts);
                } else {
                    console.error('Failed to load receipts');
                }
            } catch (error) {
                console.error('Error loading receipts:', error);
            }
        }

        // Display receipts in table
        function displayReceipts(receipts) {
            const tbody = document.getElementById('receiptsBody');
            const noReceipts = document.getElementById('noReceipts');

            tbody.innerHTML = '';

            if (receipts.length === 0) {
                noReceipts.style.display = 'block';
                return;
            }

            noReceipts.style.display = 'none';

            receipts.forEach(receipt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${receipt.date || 'N/A'}</td>
                    <td>${receipt.vendor_name || 'N/A'}</td>
                    <td>${receipt.invoice_number || 'N/A'}</td>
                    <td>$${receipt.total_amount || '0.00'}</td>
                    <td>$${receipt.tax || '0.00'}</td>
                    <td>
                        <button class="view-btn" onclick="viewReceipt('${receipt.filename}')">View</button>
                        <button class="delete-btn" onclick="deleteReceipt(${receipt.receipt_id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // View receipt
        function viewReceipt(filename) {
            window.open(`/uploads/${filename}`, '_blank');
        }

        // Delete receipt
        async function deleteReceipt(id) {
            if (!confirm('Are you sure you want to delete this receipt?')) return;

            try {
                const response = await fetch(`/api/receipts/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… Receipt deleted');
                    loadReceipts();
                } else {
                    alert('Failed to delete receipt');
                }
            } catch (error) {
                console.error('Error deleting receipt:', error);
            }
        }

        // --- SEARCH/FILTER ---
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#receiptsBody tr');
            
            rows.forEach(row => {
                const vendor = row.children[1].textContent.toLowerCase();
                row.style.display = vendor.includes(searchTerm) ? '' : 'none';
            });
        });

        // Load receipts on page load
        loadReceipts();
    </script>
</body>
</html>
